rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /lists/{listId} {
      // Tilgang for eier og samarbeidspartnere
      allow read, write: if request.auth != null && (
        // Eier har alltid tilgang
        request.auth.uid == resource.data.ownerId ||
        
        // Samarbeidspartner har tilgang (uavhengig om den er privat for andre)
        (request.auth.token.email in resource.data.collaborators) ||
        
        // Når man oppretter en ny liste
        (request.resource.data.ownerId == request.auth.uid)
      );
      
      // Kun eier kan slette listen (eller dokumentet)
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
      
      // Regler for varer i listen (subcollection)
      match /items/{itemId} {
        allow read, write: if request.auth != null && (
          // Sjekk tilgang på foreldredokumentet (listen)
          get(/databases/$(database)/documents/lists/$(listId)).data.ownerId == request.auth.uid ||
          request.auth.token.email in get(/databases/$(database)/documents/lists/$(listId)).data.collaborators
        );
      }
      
      // Shopping History - samme tilgang som listen
      match /shoppingHistory/{sessionId} {
        allow read, write: if request.auth != null && (
          get(/databases/$(database)/documents/lists/$(listId)).data.ownerId == request.auth.uid ||
          request.auth.token.email in get(/databases/$(database)/documents/lists/$(listId)).data.collaborators
        );
      }
    }
    
    // Support for collectionGroup queries (used by catalog sync)
    match /{path=**}/items/{itemId} {
      allow read, write: if request.auth != null && (
        // path[1] is the listId in the path /lists/{listId}/items/{itemId}
        get(/databases/$(database)/documents/lists/$(path[1])).data.ownerId == request.auth.uid ||
        request.auth.token.email in get(/databases/$(database)/documents/lists/$(path[1])).data.collaborators
      );
    }

    match /products/{productId} {
      // Global varekatalog - alle innloggede brukere kan lese og oppdatere
      allow read, write: if request.auth != null;

      // Allow access to price history subcollection
      match /history/{historyId} {
        allow read, write: if request.auth != null;
      }
    }

    match /configuration/{configId} {
      // Global konfigurasjon (f.eks. kategorier)
      allow read, write: if request.auth != null;
    }

    match /users/{userId} {
      // User settings - kun brukeren selv kan lese/skrive
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Personal Store Layouts - private to user
      match /storeLayouts/{storeId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    match /stores/{storeId} {
      // Global Stores - Public Read, Owner Write
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid || 
        // Allow soft delete logic if needed, but strictly controlled
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['deletedAt']))
      );
      // Hard delete forbidden - use soft delete (deletedAt)
      allow delete: if false; 
    }

    match /mail/{emailId} {
      // Allow users to queue emails (Trigger Email Extension listens here)
      allow create: if request.auth != null;
      // No read/update/delete access for users - only admin/system needs this
      allow read, update, delete: if false;
    }
  }
}

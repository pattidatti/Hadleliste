rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /lists/{listId} {
      // Tilgang for eier og samarbeidspartnere
      allow read, write: if request.auth != null && (
        // Eier har alltid tilgang
        request.auth.uid == resource.data.ownerId ||
        
        // Samarbeidspartner har tilgang (uavhengig om den er privat for andre)
        (request.auth.token.email in resource.data.collaborators) ||
        
        // Når man oppretter en ny liste
        (request.resource.data.ownerId == request.auth.uid)
      );
      
      // Kun eier kan slette listen (eller dokumentet)
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
      
      // Regler for varer i listen (subcollection)
      match /items/{itemId} {
        allow read, write: if request.auth != null && (
          // Sjekk tilgang på foreldredokumentet (listen)
          get(/databases/$(database)/documents/lists/$(listId)).data.ownerId == request.auth.uid ||
          request.auth.token.email in get(/databases/$(database)/documents/lists/$(listId)).data.collaborators
        );
      }
      
      // Shopping History - samme tilgang som listen
      match /shoppingHistory/{sessionId} {
        allow read, write: if request.auth != null && (
          get(/databases/$(database)/documents/lists/$(listId)).data.ownerId == request.auth.uid ||
          request.auth.token.email in get(/databases/$(database)/documents/lists/$(listId)).data.collaborators
        );
      }
    }

    match /products/{productId} {
      // Global varekatalog - alle innloggede brukere kan lese og oppdatere
      allow read, write: if request.auth != null;
    }

    match /configuration/{configId} {
      // Global konfigurasjon (f.eks. kategorier)
      allow read, write: if request.auth != null;
    }

    match /users/{userId} {
      // User settings - kun brukeren selv kan lese/skrive
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
